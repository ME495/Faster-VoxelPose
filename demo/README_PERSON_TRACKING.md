# 人体跟踪功能说明

本项目已集成了基于关节点距离的人体跟踪功能，可以为多视角视频数据中相邻帧之间距离最近的人体分配相同的ID。

## 功能特点

1. **基于关节点距离的匹配**：使用3D关节点之间的欧式距离来计算人体之间的相似度
2. **匈牙利算法优化匹配**：使用贪心算法近似匈牙利算法进行最优人体匹配
3. **自动ID管理**：为新出现的人体分配唯一ID，为消失的人体清理ID
4. **可配置参数**：支持配置最大丢失帧数和距离阈值

## 技术实现

### 数据结构

```cpp
struct PersonInstance {
    int person_id;                      // 唯一的人体ID
    torch::Tensor pose_3d;             // 3D姿态 (num_joints, 3)
    float confidence;                  // 人体置信度
    int last_seen_frame;               // 最后看到的帧号
};
```

### 核心算法

1. **距离计算**：计算两个人体所有关节点的欧式距离平均值
2. **匹配算法**：使用成本矩阵和贪心算法进行人体匹配
3. **ID分配**：
   - 匹配成功且距离小于阈值：保持原有ID
   - 无法匹配：分配新ID
   - 长时间未见：清理ID

### 关键参数

- `max_frame_gap`: 最大丢失帧数 (默认: 10)
- `distance_threshold`: 距离阈值 (默认: 500.0)

## 使用方法

### 编译

更新的CMakeLists.txt已包含新的源文件：

```bash
mkdir build
cd build
cmake ..
make
```

### 运行

程序会自动应用人体跟踪功能，无需额外参数：

```bash
./faster_voxelpose_demo <backbone.trt> <model.pt> <calib.json> <image_dir> <device>
```

### 输出

1. **控制台输出**：显示每帧跟踪的人体数量
2. **可视化图像**：人体会用一致的ID和颜色显示

## 模型输出格式

模型输出维度：`(batch_size, max_proposals, num_joints, 5)`

最后一维的5个值：
- `[0]`: 关节点坐标x
- `[1]`: 关节点坐标y  
- `[2]`: 关节点坐标z
- `[3]`: 是否是真实人体 (>=0表示是，跟踪后存储人体ID)
- `[4]`: 人体置信度

## 跟踪流程

1. **输入处理**：从模型输出中提取有效人体
2. **距离计算**：计算当前帧人体与已跟踪人体的距离矩阵
3. **最优匹配**：使用贪心算法找到最优匹配
4. **ID更新**：
   - 匹配的人体：更新姿态和帧号，保持ID
   - 新人体：分配新ID
   - 丢失人体：暂时保留，超时后清理
5. **输出更新**：将分配的ID写回到输出张量

## 算法优化

### 距离计算优化
- 使用PyTorch张量操作进行向量化计算
- 仅计算有效关节点的距离

### 匹配算法优化
- 贪心近似匈牙利算法，时间复杂度O(n³)
- 可替换为更精确的匈牙利算法实现

### 内存优化
- 及时清理长时间未见的人体
- 复用张量避免重复分配

## 参数调优建议

### 距离阈值 (distance_threshold)
- **较小值 (100-300)**：严格匹配，减少ID跳跃，但可能产生更多新ID
- **较大值 (500-1000)**：宽松匹配，减少新ID产生，但可能造成ID混淆

### 最大丢失帧数 (max_frame_gap)
- **较小值 (5-10)**：快速清理，减少内存占用，但对临时遮挡敏感
- **较大值 (15-30)**：保持长期跟踪，对遮挡鲁棒，但占用更多内存

## 已知限制

1. **遮挡处理**：长时间完全遮挡可能导致ID重新分配
2. **快速运动**：极快的运动可能超出距离阈值
3. **相似姿态**：相似的人体姿态可能导致ID混淆

## 未来改进

1. **外观特征**：结合图像特征提高匹配准确性
2. **运动预测**：使用卡尔曼滤波器预测人体位置
3. **深度学习**：使用学习的人体特征进行匹配
4. **多目标跟踪**：集成专门的MOT算法

## 疑难排解

### 编译错误
- 确保包含了`person_tracker.cpp`在CMakeLists.txt中
- 检查PyTorch和OpenCV依赖

### 跟踪效果不佳
- 调整距离阈值和最大丢失帧数
- 检查输入数据的关节点坐标单位
- 验证置信度阈值设置

### 性能问题
- 减少最大人体数量
- 优化距离计算的张量操作
- 考虑使用多线程处理 